<!doctype html>
<html lang="de" class="h-full bg-cyan-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adelboden-Lenk • Sillerenbühl – Überblick</title>
  <meta name="description" content="Mobile Übersicht: Webcams, Wetter (meteoblue), Tarife, Anlagen, Schneebericht & Pisten. Reines HTML/JS, eine Datei." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    iframe{ border:0; }
    .sticky-top { position: sticky; top: 0; z-index: 40; backdrop-filter: blur(6px); }
    .chip { font-size: 11px; padding: 2px 8px; border-radius: 9999px; }
  </style>
</head>
<body class="h-full text-slate-900 bg-cyan-50">
<header class="sticky-top bg-cyan-100/80 border-b border-cyan-200">
  <div class="max-w-3xl mx-auto px-4 py-2 flex items-center gap-3 relative">
    <div class="w-8 h-8 rounded-xl bg-cyan-200 flex items-center justify-center">🏔️</div>
    <div class="flex-1">
      <div class="text-sm font-semibold leading-tight">Adelboden‑Lenk • Sillerenbühl</div>
      <div class="text-xs text-slate-600">🎥 Webcams · 🌤️ Wetter · 🎟️ Tarife · 🚡 Anlagen · ❄️ Schnee · ⛷️ Pisten</div>
    </div>
    <a href="#" id="refreshBtn" class="text-xs bg-cyan-700 text-white px-3 py-1 rounded-full">Aktualisieren</a>
    <details class="ml-2">
      <summary class="text-xs cursor-pointer px-2 py-1 rounded-full border">⚙️ Daten</summary>
      <div class="absolute right-2 mt-2 w-[92vw] max-w-md bg-white border rounded-2xl shadow-xl p-3 space-y-4">
        <div>
          <div class="text-xs font-semibold mb-1">meteoblue Widget HTML (3‑Tage kompakt)</div>
          <textarea id="mbEmbed" class="w-full h-20 text-xs border rounded-xl p-2" placeholder="meteoblue Widget-Code hier einfügen"></textarea>
          <button id="saveMB" class="mt-1 text-xs bg-cyan-700 text-white px-2 py-1 rounded">meteoblue speichern</button>
          <div class="text-[11px] text-slate-500 mt-1">Ohne Widget zeigt die Seite einen Fallback (Open‑Meteo).</div>
        </div>
        <div>
          <div class="text-xs font-semibold mb-1">Preisregeln (Sommer/Winter)</div>
          <textarea id="priceRules" class="w-full h-28 text-xs border rounded-xl p-2">{
  "summer": { "weekday": 65, "weekend": 72 },
  "winter": { "weekday": 79, "weekend": 92 },
  "link": "https://www.adelboden-lenk.ch/tarife"
}</textarea>
          <button id="saveRules" class="mt-1 text-xs bg-cyan-700 text-white px-2 py-1 rounded">Preisregeln speichern</button>
          <div class="text-[11px] text-slate-500 mt-1">Die Preise sind „ab CHF …“ (dynamisch). Passe sie bei Bedarf an.</div>
        </div>
        <div>
          <div class="text-xs font-semibold mb-1">Anlagen (JSON Array)</div>
          <textarea id="liftsEdit" class="w-full h-24 text-xs border rounded-xl p-2">[
  { "name": "Oey – Bergläger", "status": "open", "from": "08:30", "to": "16:45" },
  { "name": "Bergläger – Sillerenbühl", "status": "open", "from": "08:35", "to": "16:40" },
  { "name": "Geils – Hahnenmoos", "status": "pause", "from": "09:00", "to": "16:30" }
]</textarea>
          <button id="saveLifts" class="mt-1 text-xs bg-cyan-700 text-white px-2 py-1 rounded">Anlagen speichern</button>
        </div>
        <div class="text-[11px] text-slate-500">Alles bleibt lokal im Browser (localStorage). Weiterhin nur diese eine Datei.</div>
      </div>
    </details>
  </div>
</header>

<main class="max-w-3xl mx-auto px-4 py-4 space-y-4 sm:space-y-6">

  <!-- Webcams -->
  <section class="bg-white rounded-2xl shadow-md p-4 sm:p-6">
    <h2 class="text-lg font-semibold tracking-tight mb-3 text-cyan-800">🎥 Webcams</h2>
    <div class="grid grid-cols-1 gap-3">
      <!-- Feratel: Sillerenbühl -->
      <div class="rounded-xl overflow-hidden">
        <div class="flex items-center justify-between px-2 py-1 bg-cyan-50 border-b border-cyan-100">
          <div class="text-sm font-medium">Sillerenbühl (1974 m)</div>
          <a class="text-xs text-cyan-700 underline" rel="noopener" target="_blank" href="https://webtv.feratel.com/webtv/?c0=0&c2=1&cam=4107&design=v5&lc=4107&lg=de&s=0">Quelle</a>
        </div>
        <iframe src="https://webtv.feratel.com/webtv/?c0=0&c2=1&cam=4107&design=v5&lc=4107&lg=de&s=0" width="100%" height="280" allow="autoplay; fullscreen" loading="lazy" title="Webcam Sillerenbühl (feratel)"></iframe>
      </div>
      <!-- Roundshot: Höchst (Adelboden) -->
      <div class="rounded-xl overflow-hidden">
        <div class="flex items-center justify-between px-2 py-1 bg-cyan-50 border-b border-cyan-100">
          <div class="text-sm font-medium">Höchst (Adelboden)</div>
          <a class="text-xs text-cyan-700 underline" rel="noopener" target="_blank" href="https://adelbodenlenk.roundshot.com/hoechstbahn/">Quelle</a>
        </div>
        <iframe src="https://adelbodenlenk.roundshot.com/hoechstbahn/" width="100%" height="280" loading="lazy" title="Webcam Höchst (roundshot)"></iframe>
      </div>
      <!-- Feratel: Metschstand (Lenk) -->
      <div class="rounded-xl overflow-hidden">
        <div class="flex items-center justify-between px-2 py-1 bg-cyan-50 border-b border-cyan-100">
          <div class="text-sm font-medium">Metschstand (2103 m)</div>
          <a class="text-xs text-cyan-700 underline" rel="noopener" target="_blank" href="https://webtv.feratel.com/webtv/?cam=4230&design=v5">Quelle</a>
        </div>
        <iframe src="https://webtv.feratel.com/webtv/?cam=4230&design=v5" width="100%" height="280" allow="autoplay; fullscreen" loading="lazy" title="Webcam Metschstand (feratel)"></iframe>
      </div>
    </div>
    <p class="mt-3 text-[11px] text-slate-500">Falls ein iFrame blockiert wird, bitte den „Quelle“-Link öffnen (Browser-Policy).</p>
  </section>

  <!-- Wetter (meteoblue bevorzugt) -->
  <section class="bg-white rounded-2xl shadow-md p-4 sm:p-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold tracking-tight mb-3 text-cyan-800">🌤️ Wetter</h2>
      <span id="wxUpdated" class="chip bg-cyan-100">lädt…</span>
    </div>
    <div id="mbWidget" class="rounded-xl overflow-hidden border mb-3 hidden"></div>
    <p id="mbHint" class="text-[11px] text-slate-500 hidden">Quelle: meteoblue (3‑Tage kompakt).</p>
    <div id="wxFallback" class="rounded-xl border border-cyan-100 p-3">
      <div class="text-xs text-slate-500 mb-2">Hinweis: meteoblue‑Widget noch nicht hinterlegt. Zeige Fallback.</div>
      <div id="wxNow" class="grid grid-cols-3 gap-2 text-center">
        <div><div class="text-3xl font-bold" id="tempNow">–°</div><div class="text-xs text-slate-500">Jetzt</div></div>
        <div><div class="text-lg font-semibold" id="windNow">– m/s</div><div class="text-xs text-slate-500">Wind</div></div>
        <div><div class="text-lg font-semibold" id="codeNow">–</div><div class="text-xs text-slate-500">Wettercode</div></div>
      </div>
      <div id="wxDaily" class="mt-3 grid grid-cols-3 gap-2"></div>
      <p class="mt-3 text-[11px] text-slate-500">Fallback: Open‑Meteo (Sillerenbühl).</p>
    </div>
  </section>

  <!-- Tarife (nächste 3 Tage) -->
  <section class="bg-white rounded-2xl shadow-md p-4 sm:p-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold tracking-tight mb-3 text-cyan-800">🎟️ Tarife nächste 3 Tage</h2>
      <span id="seasonBadge" class="chip bg-cyan-100">Saison</span>
    </div>
    <div id="tariffs" class="grid grid-cols-1 gap-2"></div>
  </section>

  <!-- Anlagen -->
  <section class="bg-white rounded-2xl shadow-md p-4 sm:p-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold tracking-tight mb-3 text-cyan-800">🚡 Geöffnete Anlagen</h2>
      <a class="text-xs text-cyan-700 underline" rel="noopener" target="_blank" href="https://adelboden-lenk-kandersteg.ch/en/timetables">Live-Anzeige</a>
    </div>
    <div id="lifts" class="grid grid-cols-1 gap-2"></div>
  </section>

  <!-- Schneebericht -->
  <section class="bg-white rounded-2xl shadow-md p-4 sm:p-6">
    <h2 class="text-lg font-semibold tracking-tight mb-3 text-cyan-800">❄️ Schneebericht</h2>
    <div class="grid grid-cols-2 gap-2">
      <div class="rounded-xl border border-cyan-100 p-3"><div class="text-xs text-slate-500">Tal</div><div class="text-base font-semibold" id="snowValley">0 cm</div></div>
      <div class="rounded-xl border border-cyan-100 p-3"><div class="text-xs text-slate-500">Berg</div><div class="text-base font-semibold" id="snowMountain">0 cm</div></div>
      <div class="rounded-xl border border-cyan-100 p-3"><div class="text-xs text-slate-500">Neuschnee (24h)</div><div class="text-base font-semibold" id="snowFresh">0 cm</div></div>
      <div class="rounded-xl border border-cyan-100 p-3"><div class="text-xs text-slate-500">Letzter Schneefall</div><div class="text-base font-semibold" id="snowLast">–</div></div>
    </div>
  </section>

  <!-- Pisten -->
  <section class="bg-white rounded-2xl shadow-md p-4 sm:p-6">
    <h2 class="text-lg font-semibold tracking-tight mb-3 text-cyan-800">⛷️ Pisten</h2>
    <div id="pistes" class="grid grid-cols-1 gap-2"></div>
  </section>

  <footer class="pb-8 pt-2 text-center text-[11px] text-slate-500">
    Reines HTML/JS. Keine Cookies, kein Backend. Quellen: meteoblue (Widget), Open‑Meteo, feratel/roundshot, Adelboden‑Lenk.
  </footer>
</main>

<script>
// ---- Defaults & storage ----
let RULES = {
  summer: { weekday: 65, weekend: 72 },
  winter: { weekday: 79, weekend: 92 },
  link: "https://www.adelboden-lenk.ch/tarife"
};
let DATA = {
  lifts: [
    { name: "Oey – Bergläger", status: "open", from: "08:30", to: "16:45" },
    { name: "Bergläger – Sillerenbühl", status: "open", from: "08:35", to: "16:40" },
    { name: "Geils – Hahnenmoos", status: "pause", from: "09:00", to: "16:30" }
  ],
  pistes: [
    { name: "Silleren – Adelboden (Talabfahrt)", difficulty: "red", status: "closed", length_km: 5.1 },
    { name: "Geils – Bergläger", difficulty: "blue", status: "closed", length_km: 2.3 },
    { name: "Hahnenmoos – Geils", difficulty: "red", status: "closed", length_km: 3.4 }
  ],
  snow: { valley_cm: 0, mountain_cm: 0, fresh24_cm: 0, last_snow: null, quality: null }
};
try {
  const r = localStorage.getItem('price_rules'); if (r) RULES = JSON.parse(r);
  const l = localStorage.getItem('adelboden_lifts'); if (l) DATA.lifts = JSON.parse(l);
  const p = localStorage.getItem('adelboden_pistes'); if (p) DATA.pistes = JSON.parse(p);
  const s = localStorage.getItem('adelboden_snow'); if (s) DATA.snow = JSON.parse(s);
} catch(e){}

// ---- Network time (NTP-like) via worldtimeapi; fallback to device clock ----
async function getNetworkTime() {
  try {
    const r = await fetch('https://worldtimeapi.org/api/timezone/Europe/Zurich', { cache: 'no-store' });
    const j = await r.json();
    return new Date(j.datetime);
  } catch(e) {
    return new Date();
  }
}
function isWeekend(d){ const n = d.getDay(); return n===0 || n===6; } // Sun=0
function isWinter(d){
  const m = d.getMonth(); // 0..11
  return (m === 10) || (m === 11) || (m <= 3); // Nov–Apr
}

// ---- Render helpers ----
function renderTariffs(dates, winter){
  const box = document.getElementById('tariffs');
  const seasonBadge = document.getElementById('seasonBadge');
  box.innerHTML = '';
  seasonBadge.textContent = winter ? 'Wintersaison' : 'Sommer / Off‑Season';
  dates.forEach(dt => {
    const weekend = isWeekend(dt);
    const price = weekend ? (winter ? RULES.winter.weekend : RULES.summer.weekend)
                          : (winter ? RULES.winter.weekday : RULES.summer.weekday);
    const label = dt.toLocaleDateString('de-CH', { weekday:'short', day:'2-digit', month:'2-digit' });
    const a = document.createElement('a');
    a.href = RULES.link; a.target = '_blank';
    a.className = 'rounded-xl border border-cyan-100 p-3 flex items-center justify-between hover:bg-cyan-50';
    a.innerHTML = `<div><div class="text-sm font-semibold">${label}</div>
                    <div class="text-[11px] text-slate-500">ab CHF ${price} (dynamisch)</div></div>
                   <span class="text-xs bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded-full">Zum Shop</span>`;
    box.appendChild(a);
  });
}
function renderLifts(list){
  const box = document.getElementById('lifts');
  box.innerHTML = '';
  list.forEach(item => {
    const icon = item.status === 'open' ? '✅' : item.status === 'pause' ? '🟡' : '⛔';
    const color = item.status === 'open' ? 'bg-emerald-100 text-emerald-700' :
                  item.status === 'pause' ? 'bg-amber-100 text-amber-700' : 'bg-rose-100 text-rose-700';
    const row = document.createElement('div');
    row.className = 'rounded-xl border border-cyan-100 p-3 flex items-center justify-between gap-3';
    row.innerHTML = `<div><div class="text-sm font-semibold">${item.name}</div>
                      <div class="text-[11px] text-slate-500">${item.from ? `${item.from}–${item.to}` : '—'}</div></div>
                     <span class="text-xs px-2 py-0.5 rounded-full ${color}">${icon} ${item.status}</span>`;
    box.appendChild(row);
  });
}
function renderSnow(data){
  const set = (id, v) => document.getElementById(id).textContent = v ?? '–';
  set('snowValley', `${data.valley_cm ?? 0} cm`);
  set('snowMountain', `${data.mountain_cm ?? 0} cm`);
  set('snowFresh', `${data.fresh24_cm ?? 0} cm`);
  set('snowLast', data.last_snow ? new Date(data.last_snow).toLocaleDateString('de-CH') : '–');
}
function renderPistes(list){
  const box = document.getElementById('pistes');
  box.innerHTML = '';
  list.forEach(p => {
    const icon = p.status === 'open' ? '✅' : p.status === 'part' ? '🟡' : '⛔';
    const statusColor = p.status === 'open' ? 'bg-emerald-100 text-emerald-700' :
                        p.status === 'part' ? 'bg-amber-100 text-amber-700' : 'bg-rose-100 text-rose-700';
    const difficulty = p.difficulty === 'blue' ? '🔵' : p.difficulty === 'red' ? '🔴' : '⚫';
    const row = document.createElement('div');
    row.className = 'rounded-xl border border-cyan-100 p-3 flex items-center justify-between gap-3';
    row.innerHTML = `<div><div class="text-sm font-semibold">${difficulty} ${p.name}</div>
                      <div class="text-[11px] text-slate-500">${p.length_km ? `${Number(p.length_km).toFixed(1)} km` : ''}</div></div>
                     <span class="text-xs px-2 py-0.5 rounded-full ${statusColor}">${icon} ${p.status}</span>`;
    box.appendChild(row);
  });
}

// ---- Weather (meteoblue vs Fallback) ----
function renderMBWidget(){
  const html = localStorage.getItem('mb_widget_html');
  const box = document.getElementById('mbWidget');
  const hint = document.getElementById('mbHint');
  const fb = document.getElementById('wxFallback');
  if (html && html.trim()) {
    box.innerHTML = html;
    box.classList.remove('hidden');
    hint.classList.remove('hidden');
    fb.classList.add('hidden');
    document.getElementById('wxUpdated').textContent = 'meteoblue';
  } else {
    box.classList.add('hidden');
    hint.classList.add('hidden');
    fb.classList.remove('hidden');
    loadWeatherFallback();
  }
}
async function loadWeatherFallback(){
  const url = new URL('https://api.open-meteo.com/v1/forecast');
  url.search = new URLSearchParams({
    latitude: 46.4715,
    longitude: 7.5183,
    current: 'temperature_2m,wind_speed_10m,weather_code',
    daily: 'temperature_2m_max,temperature_2m_min,precipitation_sum',
    forecast_days: '3',
    timezone: 'Europe/Zurich'
  }).toString();
  try {
    const res = await fetch(url);
    const data = await res.json();
    const { current, daily } = data;
    document.getElementById('tempNow').textContent = `${Math.round(current.temperature_2m)}°C`;
    document.getElementById('windNow').textContent = `${Math.round(current.wind_speed_10m)} m/s`;
    document.getElementById('codeNow').textContent = `WMO ${current.weather_code}`;
    document.getElementById('wxUpdated').textContent = 'Fallback';
    const daysEl = document.getElementById('wxDaily');
    daysEl.innerHTML = '';
    for (let i = 0; i < daily.time.length; i++) {
      const max = Math.round(daily.temperature_2m_max[i]);
      const min = Math.round(daily.temperature_2m_min[i]);
      const pr = Math.round(daily.precipitation_sum[i] || 0);
      const dd = new Date(daily.time[i]).toLocaleDateString('de-CH', { weekday: 'short' });
      const card = document.createElement('div');
      card.className = 'rounded-xl border border-cyan-100 p-2 text-center';
      card.innerHTML = `<div class="text-xs text-slate-500">${dd}</div>
                        <div class="text-base font-semibold">${max}° / ${min}°</div>
                        <div class="text-[11px] text-slate-500">💧 ${pr} mm</div>`;
      daysEl.appendChild(card);
    }
  } catch(e) {
    document.getElementById('wxUpdated').textContent = 'offline';
  }
}

// ---- Init using network time ----
async function init(){
  renderMBWidget();
  // network time to decide season and build 3-day horizon
  const now = await getNetworkTime();
  const winter = isWinter(now);
  const dates = [0,1,2].map(n => { const d = new Date(now); d.setDate(d.getDate()+n); return d; });
  // Off-season logic
  if (!winter) {
    // force snow 0 and pistes closed
    DATA.snow = { valley_cm: 0, mountain_cm: 0, fresh24_cm: 0, last_snow: null, quality: null };
    DATA.pistes = DATA.pistes.map(p => ({...p, status: 'closed'}));
  }
  renderTariffs(dates, winter);
  renderLifts(DATA.lifts);
  renderSnow(DATA.snow);
  renderPistes(DATA.pistes);
}

document.getElementById('refreshBtn').addEventListener('click', e => { e.preventDefault(); init(); });

// Inline Editor wiring
(function bootEditor(){
  const mbArea = document.getElementById('mbEmbed');
  const rulesArea = document.getElementById('priceRules');
  const liftsArea = document.getElementById('liftsEdit');
  try { const s = localStorage.getItem('mb_widget_html'); if (s) mbArea.value = s; } catch(e){}
  try { const pr = localStorage.getItem('price_rules'); if (pr) { RULES = JSON.parse(pr); rulesArea.value = JSON.stringify(RULES, null, 2);} } catch(e){}
  try { liftsArea.value = JSON.stringify(DATA.lifts, null, 2); } catch(e){}
  document.getElementById('saveMB').addEventListener('click', () => {
    try { localStorage.setItem('mb_widget_html', mbArea.value); renderMBWidget(); } catch(e){ alert('Konnte meteoblue Widget nicht speichern'); }
  });
  document.getElementById('saveRules').addEventListener('click', () => {
    try { const obj = JSON.parse(rulesArea.value); RULES = obj; localStorage.setItem('price_rules', JSON.stringify(obj)); init(); } catch(e){ alert('Ungültiges JSON Preisregeln'); }
  });
  document.getElementById('saveLifts').addEventListener('click', () => {
    try { const obj = JSON.parse(liftsArea.value); DATA.lifts = obj; localStorage.setItem('adelboden_lifts', JSON.stringify(obj)); renderLifts(DATA.lifts); } catch(e){ alert('Ungültiges JSON Anlagen'); }
  });
})();

init();
</script>

</body>
</html>